# Crypto Futures Signal API

## Overview
This project provides a production-ready FastAPI backend for generating real-time cryptocurrency futures trading signals. It aggregates diverse market data (price action, funding rates, open interest, social sentiment) to offer LONG/SHORT/NEUTRAL recommendations via a multi-factor weighted scoring system. The API is designed for compatibility with GPT Actions, aiming to provide a robust tool for informed trading decisions with significant market potential. Key capabilities include an advanced Multi-Modal Signal Score (MSS) system for identifying high-potential emerging cryptocurrencies and a Binance New Listings Monitor for early detection of fresh perpetual futures listings. The system also includes an advanced Hybrid AI Signal Judge (GPT-4 + rule-based fallback) for structured validation of signals with verdict system and comprehensive risk management capabilities.

## User Preferences
- Clean, modular code structure
- Comprehensive error handling with safe defaults
- Production-ready code (no mock data)
- Full async/await for performance
- Extensive comments for maintainability

## System Architecture
The application is built with FastAPI following a modular architecture, separating API routes, core business logic, and external service integrations.

### UI/UX Decisions
The API provides clean JSON responses and offers a debug mode (`?debug=true`) for detailed metrics. OpenAPI documentation is available at `/docs` and `/redoc`, including a GPT Actions-compatible schema.

### Technical Implementations
- **Signal Engine**: An 8-factor weighted scoring system (0-100 scale) generates signals based on Liquidations, Funding Rate, Price Momentum, Long/Short Ratio, Smart Money, OI Trend, Social Sentiment, and Fear & Greed.
- **Hybrid AI Signal Judge (PRODUCTION)**: Integrated GPT-4 signal validation with intelligent fallback. Every signal generated by `/signals/{symbol}` is automatically enhanced with an `aiVerdictLayer` containing:
  - **Verdict**: CONFIRM/DOWNSIZE/SKIP/WAIT decision based on comprehensive risk analysis
  - **Risk Mode**: NORMAL/REDUCED/AVOID/AGGRESSIVE classification
  - **Position Multiplier**: 0.0x-1.5x sizing recommendation (risk-based)
  - **AI Summary**: Telegram-ready explanation of the verdict
  - **Layer Checks**: Supporting factors (agreements) and risk warnings (conflicts)
  - **Volatility Metrics (NEW - Phase 2)**: ATR-based position sizing and risk management
    - **Recommended Position Multiplier**: 0.25x-2.0x based on market volatility (independent from risk-based multiplier)
    - **Stop Loss Price**: ATR-based dynamic stop loss with configurable multiples (1.5x-3.0x ATR)
    - **Take Profit Price**: Risk-reward optimized targets (1.5:1 to 3:1 R:R)
    - **ATR Value & Percentage**: Volatility measurement with classification (VERY_LOW to VERY_HIGH)
    - **Trade Plan Summary**: Human-readable position sizing, SL, and TP recommendations
  - **Fallback System**: Graceful degradation to rule-based assessment if GPT-4 fails/times out (15s timeout)
  - **Configuration**: Controlled via `ENABLE_AI_JUDGE`, `AUTO_SKIP_AVOID_SIGNALS`, `AI_JUDGE_TIMEOUT` environment variables
  - **Smart Telegram Filtering**: Automatically suppresses alerts for SKIP/AVOID verdicts to protect users from risky trades
- **AI Verdict Accuracy Tracking (NEW - Phase 2)**: Automated system to validate AI verdict effectiveness over time
  - **Outcome Tracking**: Monitors price movements at 1h, 4h, and 24h intervals after signal generation
  - **P&L Calculation**: Calculates profit/loss percentage for LONG/SHORT signals with outcome classification (WIN/LOSS/NEUTRAL)
  - **Verdict Performance Metrics**: Win rates, average P&L, and success rates by verdict type (CONFIRM/DOWNSIZE/SKIP)
  - **Comparative Analysis**: Compares performance across different verdict types and risk modes
  - **Database Storage**: PostgreSQL signal_outcomes table with price tracking and automatic background updates
  - **Analytics Endpoints**: `/analytics/verdict-performance`, `/analytics/verdict-compare`, `/analytics/outcomes-history`, `/analytics/tracking-stats`
  - **Race Condition Protection**: Per-outcome locking prevents data corruption during concurrent updates
- **Multi-Modal Signal Score (MSS)**: A 3-phase analytical framework for discovering emerging cryptocurrencies by filtering based on tokenomics, community momentum, and institutional validation.
- **Smart Money Concept (SMC) Analyzer**: Detects institutional trading patterns (BOS, CHoCH, FVG, swing points, liquidity zones) across multiple timeframes.
- **Dynamic Coin Discovery**: Integrates Binance Futures and CoinGecko for dynamic coin discovery, allowing analysis of any cryptocurrency and filtering.
- **Concurrent Data Fetching**: Utilizes `asyncio.gather` for performance.
- **Comprehensive Coinglass Integration**: Over 60 production endpoints verified operational covering various market data, liquidations, funding rates, open interest, and technical indicators.
- **Real-Time WebSocket Streaming**: WebSocket endpoint for live liquidation data across all exchanges.
- **Unified RPC Endpoint with Flat Parameters**: Single POST `/invoke` endpoint provides access to ALL 192+ operations via RPC interface, bypassing GPT Actions' 30-operation limit. Supports both nested (`args: {...}`) and flat (root-level) parameters.
- **API Endpoints**: Includes endpoints for enhanced trading signals (`/signals/{symbol}`), aggregated raw market data (`/market/{symbol}`), GPT Actions flat parameter endpoints (`POST /gpt/signal`, etc.), unified RPC endpoint (`POST /invoke`), direct Coinglass and LunarCrush data access, Smart Money analysis, MSS functionality, Binance New Listings, WebSocket streaming, and OpenAI V2 Signal Judge validation endpoints.
- **Signal History Storage**: Stores LONG/SHORT signals and high-scoring MSS signals in a PostgreSQL database (Neon) with JSON file backup.
- **Telegram Notifier**: Provides human-friendly signal alerts with AI verdict information, risk mode indicators, position sizing guidance, and supporting/conflicting factor analysis.

### Feature Specifications
- **Comprehensive Integrations**: Leverages Coinglass v4 for market data; LunarCrush v4 for social sentiment; CoinAPI for comprehensive market data and whale detection; Binance Futures for futures market data; and CoinGecko for coin discovery.
- **LunarCrush v4 Features**: Coins Discovery endpoint with Galaxy Score and AltRank filtering, Topics API for social metrics and trend analysis, tracking over 7,634 coins.
- **Output**: Signals include recommendation, composite score, confidence level, top 3 contributing factors, and raw metrics (in debug mode). MSS alerts include a 3-phase breakdown and tier classification.

### System Design Choices
- **Framework**: FastAPI 0.104.1
- **Server**: Uvicorn
- **HTTP Client**: httpx
- **Validation**: Pydantic v2
- **Database**: PostgreSQL (Neon) with `asyncpg` driver and connection pooling.
- **Environment Management**: python-dotenv.

## External Dependencies
- **CoinAPI Startup**: Market data, OHLCV, order book depth, recent trades, real-time quotes, multi-exchange price aggregation, and whale detection.
- **Coinglass v4 Standard**: Provides access to liquidations, funding rates, open interest, trader positioning, whale intelligence, technical analysis (RSI, various indicators), macro calendar, news feed, and real-time WebSocket streaming.
- **Coinglass WebSocket**: Real-time liquidation streaming at `wss://open-ws.coinglass.com/ws-api`.
- **LunarCrush Builder**: Social sentiment, community engagement metrics, social momentum analysis, and real-time coin discovery.
- **OKX Public API**: Candlestick/OHLCV data.
- **Binance Futures API**: Public API for futures market data, coin discovery, 24hr statistics, funding rates, open interest, and new listings information.
- **CoinGecko API**: Coin discovery, market cap filtering, volume analysis, and category-based coin search.
- **Neon (PostgreSQL)**: Managed PostgreSQL database for signal history storage.